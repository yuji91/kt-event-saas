# 🔐 認証・認可設計ガイドライン

このドキュメントは、本サービスにおける「認証・認可の方針」および「各ドメインごとの責務と構成」について記述したものです。

---

## 1. 📚 ドメイン一覧と認証方式

| ドメイン       | UI形式         | 認証方式           | テーブル         | エンドポイント                |
|----------------|----------------|--------------------|------------------|---------------------------|
| Administrator  | 管理画面（Thymeleaf） | セッション認証（Cookie） | `administrators` | `/admin/**`               |
| Organizer      | SPA（React）   | JWT認証（Bearer）  | `organizers`     | `/organizer/graphql`      |
| Customer       | SPA（React）   | JWT認証（Bearer）  | `customers`      | `/customer/graphql`       |

---

## 2. 🧩 認証方式とFilterChainの分離

各ドメインの認証方式に応じて、Spring Security の `SecurityFilterChain` を明確に分離します。

| パス                     | 用途                     | 認証方式                           | 適用ロール         |
|--------------------------|--------------------------|------------------------------------|--------------------|
| `/admin/**`              | 管理画面（Thymeleaf）    | セッション認証（FormLogin + Cookie） | `ROLE_SYS_ADMIN`   |
| `/organizer/graphql`     | 主催者向けGraphQL API    | JWT認証（Bearer トークン）          | `ROLE_ORGANIZER`   |
| `/customer/graphql`      | 参加者向けGraphQL API    | JWT認証（Bearer トークン）          | `ROLE_CUSTOMER`    |

> 📝 補足：
> - `/admin/**` は当面 UI 用のみ。将来的に `/admin-api/**` を別ルートで追加可能な構造としています。
> - `SecurityFilterChain` は URLパターン単位で設定し、CSRF, 認証方式, 例外ハンドラなども責務別に制御します。
> - セッションCookieには `Secure`, `HttpOnly`, `SameSite=Strict` などの属性を設定し、セキュリティを強化予定です。
> - JWTを使用するSPAドメインでは、CORS設定をFilterChainごとに分離し、許可オリジンと認証ヘッダを明示的に指定する予定です。


## 3. 🔖 認証対応ステップ概要 - 対応バージョンとユーザー種別ごとのマッピング一覧

| ユーザー種別                  | v1.0.0 | v1.1.0         | v2.0.0 | v2.1.0 | 備考                                                                 |
|------------------------------|--------|----------------|--------|--------|----------------------------------------------------------------------|
| 👨‍💼 管理者（Administrator）  | ✅     | ✅             | ✅（共存可） | ✅     | セッション認証とJWT認証の**併存構成**で運用                                      |
| 📅 イベント主催者（Organizer）| ❌     | 🛠️（準備）     | ✅     | ✅     | v1.1.0でテーブル作成・初期ユーザー登録、v2.0.0でJWT認証を導入                     |
| 🎫 一般ユーザー（参加者）     | ❌     | ❌             | ✅     | ✅     | JWTによりSPA認証が可能に                                                  |
| 💳 Stripe Webhook            | ❌     | ❌             | ❌     | 🔜     | v2.2.0 にて **HMAC署名付きWebhook検証** を追加予定                             |
| 📊 モニタリング用ユーザー     | ❌     | ❌             | ❌     | ⚠️     | v2.2.0 以降で `/actuator/**` に **BasicAuth または TokenGuard** を付与予定（方式検討中） |

> 📌 JWTは `HS256` 署名方式を採用し、有効期限は30分。必要に応じてリフレッシュトークンの導入も検討中です。

## 4. 🔐 認証対応ステップ詳細 - 対応バージョンと実装、テスト項目表

本ドキュメントは、本サービスにおける認証機能の導入フェーズごとの技術的な実装・テスト項目を簡潔にまとめたものです。  
複数ドメイン（Administrator / Organizer / Customer）における認証の分離構成に沿って、フェーズ単位で整理しています。

---

## 🔹 v1.0.0（管理者UI：セッション認証）

このバージョンでは、SaaS運営者（Administrator）向けの管理画面を提供し、セッションベースの認証機構を導入します。

### ✅ 技術導入観点のチェックリスト

| 区分   | チェック項目                                                   | 対象領域     | 備考                                        | 対応状況 |
|--------|------------------------------------------------------------------|--------------|---------------------------------------------|----|
| 実装   | `administrators` テーブルの作成（`email`, `password_digest` 等） | Administrator | ロール付きログイン可能な管理者ユーザー       | 🔄   |
| 実装   | セッション認証（Spring Security + LoginForm）構成                | Administrator | フォームログイン＋Cookie保存方式             | 🔄   |
| 実装   | `/admin-api/**` に対するアクセス制御（認証・ロール）              | Administrator | セキュリティFilterChainで制限                | 🔄   |
| 実装   | CSRFトークンの埋め込みと検証（Thymeleaf）                        | Administrator | フォーム送信による改ざん対策                 | 🔄   |
| テスト | ログイン成功・失敗・セッションタイムアウト時の挙動確認            | Administrator | ログインリダイレクト含む一連の挙動確認       | 🔄   |
| テスト | 非ログイン時の `/admin-api/**` へのアクセス制限確認               | Administrator | 401 or リダイレクトされるかどうか            | 🔄   |

---

## 🔹 v1.1.0（JWT導入に向けた準備：Organizer）

このバージョンでは、JWT 認証導入に備え、Organizer ドメインのユーザー管理機構を整備します。

### ✅ 技術導入観点のチェックリスト

| 区分   | チェック項目                                                   | 対象領域     | 備考                                        | 対応状況 |
|--------|------------------------------------------------------------------|--------------|---------------------------------------------|------|
| 実装   | `organizers` テーブルの作成（`tenant_id`, `email`, `role` 等）   | Organizer     | テナント単位の主催者ユーザーを管理          | 🔄     |
| 実装   | テナント作成時に OWNER ロールのOrganizerを同時作成                | Organizer     | 認証用ユーザーを最初から登録できるように     | 🔄     |
| テスト | `tenant_id × email` の一意制約確認                                | Organizer     | 同一テナント内の重複登録を防止              | 🔄     |
| テスト | `tenant + organizer` 作成時のロールバック挙動確認                | Organizer     | トランザクション整合性を担保                 | 🔄     |

📌 補足：
- `tenants` テーブルおよび RLS（Row Level Security）は `V1__initial_schema.sql` にて対応済。
- `customers` はこのフェーズでは未定義で、v2.0.0 で導入。

---

## 🔹 v2.0.0（JWT認証の導入：Organizer / Customer）

このバージョンでは、Organizer / Customer 双方に対して JWT 認証機能を導入します。

### ✅ 技術導入観点のチェックリスト

| 区分   | チェック項目                                                    | 対象ドメイン    | 備考                               | 対応状況 |
|--------|------------------------------------------------------------------|------------------|------------------------------------|----|
| 実装   | JWT認証フィルター導入（Bearerトークン対応）                      | Organizer, Customer | Spring Security FilterChain設定     | 🔄   |
| 実装   | ログイン処理とJWT発行機能の実装（email + password）             | Organizer, Customer | `sub`, `role`, `tenantId`などを含める | 🔄   |
| 実装   | `/organizer/graphql`, `/customer/graphql` のルート分離           | Organizer, Customer | 認可とFilterChainの責務を明確化     | 🔄   |
| 実装   | `customers` テーブルの作成                                       | Customer           | `email`, `password_digest`, `is_active`等 | 🔄   |
| テスト | JWTなし・期限切れ・不正署名のアクセス拒否                        | Organizer, Customer | 各ドメイン単位で確認                 | 🔄   |
| テスト | ロール越境アクセスの拒否（例：Customer → Organizer）             | Organizer, Customer | 認可制御の正当性                     | 🔄   |

---

## 🔹 v2.1.0（REST × GraphQL の併用）

このバージョンでは、GraphQLに加えて一部ユースケースをREST APIで提供し、責務に応じたAPI分離を実現します。

### ✅ 技術導入観点のチェックリスト

| 区分   | チェック項目                                                        | 対象領域     | 備考                        | 対応状況 |
|--------|---------------------------------------------------------------|--------------|---------------------------|-----|
| 実装   | REST API の追加（例：チケット購入 `/api/tickets/purchase`）                | Customer     | GraphQLではなく専用のHTTP APIで処理 | 🔄    |
| 実装   | REST API に対する JWT 認証ガードの適用                                    | Organizer, Customer | GraphQLと同等の認証制御を実装        | 🔄    |
| 実装   | GraphQLスキーマの物理分割配置（`/organizer/schema/`, `/customer/schema/`） | Organizer, Customer | ロールごとの型生成、静的検証の分離         | 🔄    |
| テスト | REST と GraphQL の相互アクセス制限確認（別ドメインのエンドポイントにはアクセス不可） | Organizer, Customer | FilterChain や ルート誤設定の確認   | 🔄    |
| テスト | REST API経由の購入処理におけるJWT/RLS連携確認                                | Customer     | トークンに基づいた適切なテナント制御        | 🔄    |

---

## 🔹 v2.2.0（Webhook・監視系）

このバージョンでは、Stripe連携のWebhook受信やアプリケーションの監視機能を導入します。

### ✅ 技術導入観点のチェックリスト

| 区分   | チェック項目                                                    | 対象領域     | 備考                                          | 対応状況 |
|--------|------------------------------------------------------------------|--------------|-----------------------------------------------|----------|
| 実装   | Stripe Webhook 受信用エンドポイント（例：`/webhook/stripe`）の追加 | External     | トランザクション通知の受信処理を定義           | 🔄        |
| 実装   | Webhook署名（HMAC）の検証ロジックの実装                          | External     | Stripeの `sig_header` に基づく正当性検証       | 🔄        |
| 実装   | `/actuator/health` や `/metrics` などの監視エンドポイント有効化     | Monitoring   | Spring Boot Actuator ベース                   | 🔄        |
| テスト | Webhookの署名成功・失敗ケースの確認                              | External     | 正常系・異常系を網羅                          | 🔄        |
| テスト | ヘルスチェックAPIが適切に応答するか確認（200 OK）                 | Monitoring   | CI環境や本番監視システムとの連携を想定         | 🔄        |

> 📌 Webhookは `sig_header` のHMAC検証に加えて、署名タイムスタンプを用いたリプレイ攻撃対策、IP制限などの対策も検討中です。

## 記号凡例

| 記号 | 状態分類     | 意味                                                |
|------|--------------|-----------------------------------------------------|
| ✅   | 対応済        | 実装・テスト・確認済み（本番反映可能）                    |
| 🔄   | 対応予定      | 実装・設計方針は決定済み、今後対応予定（vNext以降に実施）    |
| 🛠️   | 準備対応済    | 下位構造（テーブル・RLSなど）などは構築済。上位機能は未着手     |
| 🚧   | 実装中        | 対応作業中。レビューまたは統合待ち                          |
| ❌   | 未対応        | まだ着手していない。仕様未確定 or 対応不要の可能性あり          |
| ⚠️   | 要検討        | 仕様調整中または設計検討段階で、対応可否も含めて議論が必要      |
